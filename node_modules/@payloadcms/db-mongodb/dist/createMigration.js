/* eslint-disable no-restricted-syntax, no-await-in-loop */ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "createMigration", {
    enumerable: true,
    get: function() {
        return createMigration;
    }
});
const _fs = /*#__PURE__*/ _interop_require_default(require("fs"));
const _path = /*#__PURE__*/ _interop_require_default(require("path"));
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
const migrationTemplate = (upSQL, downSQL)=>`import {
  MigrateUpArgs,
  MigrateDownArgs,
} from "@payloadcms/db-mongodb";

export async function up({ payload }: MigrateUpArgs): Promise<void> {
${upSQL ?? `  // Migration code`}
};

export async function down({ payload }: MigrateDownArgs): Promise<void> {
${downSQL ?? `  // Migration code`}
};
`;
const createMigration = async function createMigration({ file, migrationName, payload }) {
    const dir = payload.db.migrationDir;
    if (!_fs.default.existsSync(dir)) {
        _fs.default.mkdirSync(dir);
    }
    let migrationFileContent;
    // Check for predefined migration.
    // Either passed in via --file or prefixed with @payloadcms/db-mongodb/
    if (file || migrationName?.startsWith('@payloadcms/db-mongodb/')) {
        if (!file) file = migrationName;
        const predefinedMigrationName = file.replace('@payloadcms/db-mongodb/', '');
        migrationName = predefinedMigrationName;
        const cleanPath = _path.default.join(__dirname, `../predefinedMigrations/${predefinedMigrationName}.js`);
        // Check if predefined migration exists
        if (_fs.default.existsSync(cleanPath)) {
            const { down, up } = require(cleanPath);
            migrationFileContent = migrationTemplate(up, down);
        } else {
            payload.logger.error({
                msg: `Canned migration ${predefinedMigrationName} not found.`
            });
            process.exit(1);
        }
    } else {
        migrationFileContent = migrationTemplate();
    }
    const [yyymmdd, hhmmss] = new Date().toISOString().split('T');
    const formattedDate = yyymmdd.replace(/\D/g, '');
    const formattedTime = hhmmss.split('.')[0].replace(/\D/g, '');
    const timestamp = `${formattedDate}_${formattedTime}`;
    const formattedName = migrationName?.replace(/\W/g, '_');
    const fileName = migrationName ? `${timestamp}_${formattedName}.ts` : `${timestamp}_migration.ts`;
    const filePath = `${dir}/${fileName}`;
    _fs.default.writeFileSync(filePath, migrationFileContent);
    payload.logger.info({
        msg: `Migration created at ${filePath}`
    });
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVNaWdyYXRpb24udHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tcmVzdHJpY3RlZC1zeW50YXgsIG5vLWF3YWl0LWluLWxvb3AgKi9cbmltcG9ydCB0eXBlIHsgQ3JlYXRlTWlncmF0aW9uIH0gZnJvbSAncGF5bG9hZC9kYXRhYmFzZSdcblxuaW1wb3J0IGZzIGZyb20gJ2ZzJ1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcblxuY29uc3QgbWlncmF0aW9uVGVtcGxhdGUgPSAodXBTUUw/OiBzdHJpbmcsIGRvd25TUUw/OiBzdHJpbmcpID0+IGBpbXBvcnQge1xuICBNaWdyYXRlVXBBcmdzLFxuICBNaWdyYXRlRG93bkFyZ3MsXG59IGZyb20gXCJAcGF5bG9hZGNtcy9kYi1tb25nb2RiXCI7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cCh7IHBheWxvYWQgfTogTWlncmF0ZVVwQXJncyk6IFByb21pc2U8dm9pZD4ge1xuJHt1cFNRTCA/PyBgICAvLyBNaWdyYXRpb24gY29kZWB9XG59O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZG93bih7IHBheWxvYWQgfTogTWlncmF0ZURvd25BcmdzKTogUHJvbWlzZTx2b2lkPiB7XG4ke2Rvd25TUUwgPz8gYCAgLy8gTWlncmF0aW9uIGNvZGVgfVxufTtcbmBcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZU1pZ3JhdGlvbjogQ3JlYXRlTWlncmF0aW9uID0gYXN5bmMgZnVuY3Rpb24gY3JlYXRlTWlncmF0aW9uKHtcbiAgZmlsZSxcbiAgbWlncmF0aW9uTmFtZSxcbiAgcGF5bG9hZCxcbn0pIHtcbiAgY29uc3QgZGlyID0gcGF5bG9hZC5kYi5taWdyYXRpb25EaXJcbiAgaWYgKCFmcy5leGlzdHNTeW5jKGRpcikpIHtcbiAgICBmcy5ta2RpclN5bmMoZGlyKVxuICB9XG5cbiAgbGV0IG1pZ3JhdGlvbkZpbGVDb250ZW50OiBzdHJpbmcgfCB1bmRlZmluZWRcblxuICAvLyBDaGVjayBmb3IgcHJlZGVmaW5lZCBtaWdyYXRpb24uXG4gIC8vIEVpdGhlciBwYXNzZWQgaW4gdmlhIC0tZmlsZSBvciBwcmVmaXhlZCB3aXRoIEBwYXlsb2FkY21zL2RiLW1vbmdvZGIvXG4gIGlmIChmaWxlIHx8IG1pZ3JhdGlvbk5hbWU/LnN0YXJ0c1dpdGgoJ0BwYXlsb2FkY21zL2RiLW1vbmdvZGIvJykpIHtcbiAgICBpZiAoIWZpbGUpIGZpbGUgPSBtaWdyYXRpb25OYW1lXG5cbiAgICBjb25zdCBwcmVkZWZpbmVkTWlncmF0aW9uTmFtZSA9IGZpbGUucmVwbGFjZSgnQHBheWxvYWRjbXMvZGItbW9uZ29kYi8nLCAnJylcbiAgICBtaWdyYXRpb25OYW1lID0gcHJlZGVmaW5lZE1pZ3JhdGlvbk5hbWVcbiAgICBjb25zdCBjbGVhblBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCBgLi4vcHJlZGVmaW5lZE1pZ3JhdGlvbnMvJHtwcmVkZWZpbmVkTWlncmF0aW9uTmFtZX0uanNgKVxuXG4gICAgLy8gQ2hlY2sgaWYgcHJlZGVmaW5lZCBtaWdyYXRpb24gZXhpc3RzXG4gICAgaWYgKGZzLmV4aXN0c1N5bmMoY2xlYW5QYXRoKSkge1xuICAgICAgY29uc3QgeyBkb3duLCB1cCB9ID0gcmVxdWlyZShjbGVhblBhdGgpXG4gICAgICBtaWdyYXRpb25GaWxlQ29udGVudCA9IG1pZ3JhdGlvblRlbXBsYXRlKHVwLCBkb3duKVxuICAgIH0gZWxzZSB7XG4gICAgICBwYXlsb2FkLmxvZ2dlci5lcnJvcih7XG4gICAgICAgIG1zZzogYENhbm5lZCBtaWdyYXRpb24gJHtwcmVkZWZpbmVkTWlncmF0aW9uTmFtZX0gbm90IGZvdW5kLmAsXG4gICAgICB9KVxuICAgICAgcHJvY2Vzcy5leGl0KDEpXG4gICAgfVxuICB9IGVsc2Uge1xuICAgIG1pZ3JhdGlvbkZpbGVDb250ZW50ID0gbWlncmF0aW9uVGVtcGxhdGUoKVxuICB9XG5cbiAgY29uc3QgW3l5eW1tZGQsIGhobW1zc10gPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVxuICBjb25zdCBmb3JtYXR0ZWREYXRlID0geXl5bW1kZC5yZXBsYWNlKC9cXEQvZywgJycpXG4gIGNvbnN0IGZvcm1hdHRlZFRpbWUgPSBoaG1tc3Muc3BsaXQoJy4nKVswXS5yZXBsYWNlKC9cXEQvZywgJycpXG5cbiAgY29uc3QgdGltZXN0YW1wID0gYCR7Zm9ybWF0dGVkRGF0ZX1fJHtmb3JtYXR0ZWRUaW1lfWBcblxuICBjb25zdCBmb3JtYXR0ZWROYW1lID0gbWlncmF0aW9uTmFtZT8ucmVwbGFjZSgvXFxXL2csICdfJylcbiAgY29uc3QgZmlsZU5hbWUgPSBtaWdyYXRpb25OYW1lID8gYCR7dGltZXN0YW1wfV8ke2Zvcm1hdHRlZE5hbWV9LnRzYCA6IGAke3RpbWVzdGFtcH1fbWlncmF0aW9uLnRzYFxuICBjb25zdCBmaWxlUGF0aCA9IGAke2Rpcn0vJHtmaWxlTmFtZX1gXG4gIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIG1pZ3JhdGlvbkZpbGVDb250ZW50KVxuICBwYXlsb2FkLmxvZ2dlci5pbmZvKHsgbXNnOiBgTWlncmF0aW9uIGNyZWF0ZWQgYXQgJHtmaWxlUGF0aH1gIH0pXG59XG4iXSwibmFtZXMiOlsiY3JlYXRlTWlncmF0aW9uIiwibWlncmF0aW9uVGVtcGxhdGUiLCJ1cFNRTCIsImRvd25TUUwiLCJmaWxlIiwibWlncmF0aW9uTmFtZSIsInBheWxvYWQiLCJkaXIiLCJkYiIsIm1pZ3JhdGlvbkRpciIsImZzIiwiZXhpc3RzU3luYyIsIm1rZGlyU3luYyIsIm1pZ3JhdGlvbkZpbGVDb250ZW50Iiwic3RhcnRzV2l0aCIsInByZWRlZmluZWRNaWdyYXRpb25OYW1lIiwicmVwbGFjZSIsImNsZWFuUGF0aCIsInBhdGgiLCJqb2luIiwiX19kaXJuYW1lIiwiZG93biIsInVwIiwicmVxdWlyZSIsImxvZ2dlciIsImVycm9yIiwibXNnIiwicHJvY2VzcyIsImV4aXQiLCJ5eXltbWRkIiwiaGhtbXNzIiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwic3BsaXQiLCJmb3JtYXR0ZWREYXRlIiwiZm9ybWF0dGVkVGltZSIsInRpbWVzdGFtcCIsImZvcm1hdHRlZE5hbWUiLCJmaWxlTmFtZSIsImZpbGVQYXRoIiwid3JpdGVGaWxlU3luYyIsImluZm8iXSwibWFwcGluZ3MiOiJBQUFBLHlEQUF5RDs7OzsrQkFvQjVDQTs7O2VBQUFBOzs7MkRBakJFOzZEQUNFOzs7Ozs7QUFFakIsTUFBTUMsb0JBQW9CLENBQUNDLE9BQWdCQyxVQUFxQixDQUFDOzs7Ozs7QUFNakUsRUFBRUQsU0FBUyxDQUFDLG1CQUFtQixDQUFDLENBQUM7Ozs7QUFJakMsRUFBRUMsV0FBVyxDQUFDLG1CQUFtQixDQUFDLENBQUM7O0FBRW5DLENBQUM7QUFFTSxNQUFNSCxrQkFBbUMsZUFBZUEsZ0JBQWdCLEVBQzdFSSxJQUFJLEVBQ0pDLGFBQWEsRUFDYkMsT0FBTyxFQUNSO0lBQ0MsTUFBTUMsTUFBTUQsUUFBUUUsRUFBRSxDQUFDQyxZQUFZO0lBQ25DLElBQUksQ0FBQ0MsV0FBRSxDQUFDQyxVQUFVLENBQUNKLE1BQU07UUFDdkJHLFdBQUUsQ0FBQ0UsU0FBUyxDQUFDTDtJQUNmO0lBRUEsSUFBSU07SUFFSixrQ0FBa0M7SUFDbEMsdUVBQXVFO0lBQ3ZFLElBQUlULFFBQVFDLGVBQWVTLFdBQVcsNEJBQTRCO1FBQ2hFLElBQUksQ0FBQ1YsTUFBTUEsT0FBT0M7UUFFbEIsTUFBTVUsMEJBQTBCWCxLQUFLWSxPQUFPLENBQUMsMkJBQTJCO1FBQ3hFWCxnQkFBZ0JVO1FBQ2hCLE1BQU1FLFlBQVlDLGFBQUksQ0FBQ0MsSUFBSSxDQUFDQyxXQUFXLENBQUMsd0JBQXdCLEVBQUVMLHdCQUF3QixHQUFHLENBQUM7UUFFOUYsdUNBQXVDO1FBQ3ZDLElBQUlMLFdBQUUsQ0FBQ0MsVUFBVSxDQUFDTSxZQUFZO1lBQzVCLE1BQU0sRUFBRUksSUFBSSxFQUFFQyxFQUFFLEVBQUUsR0FBR0MsUUFBUU47WUFDN0JKLHVCQUF1Qlosa0JBQWtCcUIsSUFBSUQ7UUFDL0MsT0FBTztZQUNMZixRQUFRa0IsTUFBTSxDQUFDQyxLQUFLLENBQUM7Z0JBQ25CQyxLQUFLLENBQUMsaUJBQWlCLEVBQUVYLHdCQUF3QixXQUFXLENBQUM7WUFDL0Q7WUFDQVksUUFBUUMsSUFBSSxDQUFDO1FBQ2Y7SUFDRixPQUFPO1FBQ0xmLHVCQUF1Qlo7SUFDekI7SUFFQSxNQUFNLENBQUM0QixTQUFTQyxPQUFPLEdBQUcsSUFBSUMsT0FBT0MsV0FBVyxHQUFHQyxLQUFLLENBQUM7SUFDekQsTUFBTUMsZ0JBQWdCTCxRQUFRYixPQUFPLENBQUMsT0FBTztJQUM3QyxNQUFNbUIsZ0JBQWdCTCxPQUFPRyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQ2pCLE9BQU8sQ0FBQyxPQUFPO0lBRTFELE1BQU1vQixZQUFZLENBQUMsRUFBRUYsY0FBYyxDQUFDLEVBQUVDLGNBQWMsQ0FBQztJQUVyRCxNQUFNRSxnQkFBZ0JoQyxlQUFlVyxRQUFRLE9BQU87SUFDcEQsTUFBTXNCLFdBQVdqQyxnQkFBZ0IsQ0FBQyxFQUFFK0IsVUFBVSxDQUFDLEVBQUVDLGNBQWMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFRCxVQUFVLGFBQWEsQ0FBQztJQUNqRyxNQUFNRyxXQUFXLENBQUMsRUFBRWhDLElBQUksQ0FBQyxFQUFFK0IsU0FBUyxDQUFDO0lBQ3JDNUIsV0FBRSxDQUFDOEIsYUFBYSxDQUFDRCxVQUFVMUI7SUFDM0JQLFFBQVFrQixNQUFNLENBQUNpQixJQUFJLENBQUM7UUFBRWYsS0FBSyxDQUFDLHFCQUFxQixFQUFFYSxTQUFTLENBQUM7SUFBQztBQUNoRSJ9